{"version":3,"file":"index-t2eUbZIl.js","sources":["../src/plugins/demo/index.js"],"sourcesContent":["import { ImgAny } from '@/utils/ImageTools';\nimport { waitForElementById } from '@/utils/waitForElementById';\nconst $ = query => document.body.querySelector(query);\nconst flag0 = 'flag{\\x71w\\x71}';\nexport default function(isBeta = false) {\n  (function() {\n    const t = new Date();\n    if (t.getDate() !== 1 || t.getMonth() !== 3) return;\n    import('./reverse.js');\n  }());\n  hook.before.set(flag0, () => {\n    const md5 = hook.chartsMD5.get(hook.selectchart.value);\n    console.log(hook.tmps.name);\n    if (md5 === 'ab9d2cc3eb569236ead459ad4caba109') hook.now.set(flag0, loadModYukiOri());\n    else hook.now.delete(flag0);\n  });\n  const id = setInterval(() => {\n    if (!$('.title>small')) return;\n    clearInterval(id);\n    let tid = 3;\n    $('.title>small').addEventListener('click', () => {\n      if (--tid) return;\n      const uidDemo = Utils.randomUUID();\n      const uidLegacy = Utils.randomUUID();\n      const uidPreview = Utils.randomUUID();\n      const div = hook.toast([\n        `<a id=\"${uidDemo}\" href=\"#\">demo.zip</a>`,\n        `<a id=\"${uidLegacy}\" href=\"#\">Legacy</a>`,\n        `<a id=\"${uidPreview}\" href=\"#\">${isBeta ? 'Normal' : 'Beta'}</a>`\n      ].join('<br><br>'));\n      waitForElementById(uidDemo, elem => {\n        elem.addEventListener('click', () => {\n          const handler = img => hook.uploader.fireLoad({ name: 'demo.zip' }, ImgAny.decodeAlt(img));\n          const xhr = new XMLHttpRequest();\n          xhr.open('GET', '//i0.hdslb.com/bfs/music/1682346166.jpg', true);\n          xhr.responseType = 'blob';\n          xhr.onprogress = evt => hook.uploader.fireProgress(evt.loaded, evt.total);\n          xhr.onloadend = () => createImageBitmap(xhr.response).then(handler);\n          setNoReferrer(() => xhr.send());\n          div.dispatchEvent(new Event('custom-done'));\n        });\n      });\n      waitForElementById(uidLegacy, elem => {\n        elem.addEventListener('click', () => {\n          location.replace('/sim-phi-legacy');\n          div.dispatchEvent(new Event('custom-done'));\n        });\n      });\n      waitForElementById(uidPreview, elem => {\n        elem.addEventListener('click', () => {\n          location.replace(isBeta ? '/sim-phi' : '/sim-phi-vite');\n          div.dispatchEvent(new Event('custom-done'));\n        });\n      });\n    });\n  }, 500);\n}\nfunction loadModYukiOri() {\n  console.log('好耶');\n  const analyser = hook.audio.actx.createAnalyser();\n  analyser.fftSize = 4096;\n  // analyser.minDecibels = -180;\n  const getFreq = () => {\n    // progress变为频谱图\n    const bufferLength = analyser.frequencyBinCount;\n    const freq = new Uint8Array(bufferLength);\n    analyser.getByteFrequencyData(freq);\n    const avg = freq.reduce((a, b) => a + b) / bufferLength;\n    return Math.min(1, avg / 255 * 2.15); // FIXME: more accurate formula\n  };\n  let flagMusic = null;\n  let flagPerfect = NaN;\n  let flagGood = NaN;\n  let flagBad = NaN;\n  let flagEm = '';\n  let flagN = false;\n  const setFlag = (flag, em, n) => {\n    flagEm = em;\n    flagN = n;\n    return flag;\n  };\n  return time => {\n    const time1 = time * 1.95;\n    const bgMusic = hook.tmps.bgMusicHack();\n    if (bgMusic && bgMusic !== flagMusic) {\n      bgMusic.connect(analyser); // ?\n      flagMusic = bgMusic;\n    }\n    if (time1 < 168) {\n      hook.stat.numOfNotes = 305;\n      hook.tmps.level = 'lN\\u2002Lv.I2';\n      hook.tmps.progress = time1 / 218;\n    } else if (time1 < 169) {\n      const progress = 1 - (169 - time1) ** 3; // easeCubicOut\n      hook.stat.numOfNotes = 305 + 2195 * progress | 0;\n      hook.tmps.progress = getFreq();\n    } else {\n      hook.stat.numOfNotes = 2500;\n      hook.tmps.progress = getFreq();\n    }\n    if (time1 > 325 && time1 < 358) {\n      // 监听判定变化\n      const statusP = hook.stat.perfect;\n      const statusG = hook.stat.good;\n      const statusB = hook.stat.bad;\n      if (isNaN(flagPerfect)) flagPerfect = statusP;\n      if (isNaN(flagGood)) flagGood = statusG;\n      if (isNaN(flagBad)) flagBad = statusB;\n      if (statusP !== flagPerfect) flagPerfect = setFlag(statusP, '\\uff2f(\\u2267\\u25bd\\u2266)\\uff2f', true);\n      else if (statusG !== flagGood) flagGood = setFlag(statusG, '(\\uff3e\\u03c9\\uff3e)', true);\n      else if (statusB !== flagBad) flagBad = setFlag(statusB, '(\\u2299\\ufe4f\\u2299;)', true);\n      // 监听时间变化\n      if (time1 < 327) setFlag(null, '(\\u2299o\\u2299)', false);\n      else if (time1 > 334 && time1 < 335) setFlag(null, '(\\u2299o\\u2299)', false);\n      else if (time1 > 342 && time1 < 343) setFlag(null, '(\\u2299o\\u2299)', false);\n      else if (time1 > 350 && time1 < 351) setFlag(null, '(\\u2299o\\u2299)', false);\n      else if (!flagN) flagEm = '(\\u2299ω\\u2299)';\n      hook.tmps.combo = flagEm;\n    }\n  };\n}\nfunction setNoReferrer(handler = () => {}) {\n  const meta = Object.assign(document.createElement('meta'), { content: 'no-referrer', name: 'referrer' });\n  document.head.appendChild(meta); handler(); meta.remove();\n}\n"],"names":["$","query","document","body","querySelector","flag0","index","isBeta","t","Date","getDate","getMonth","import","hook","before","set","md5","chartsMD5","get","selectchart","value","console","log","tmps","name","now","analyser","audio","actx","createAnalyser","fftSize","getFreq","l","bufferLength","frequencyBinCount","freq","Uint8Array","getByteFrequencyData","avg","reduce","a","b","Math","min","flagMusic","flagPerfect","NaN","flagGood","flagBad","flagEm","flagN","setFlag","n","flag","em","time","time1","bgMusic","bgMusicHack","connect","stat","numOfNotes","level","progress","statusP","perfect","statusG","good","statusB","bad","isNaN","combo","loadModYukiOri","delete","id","setInterval","clearInterval","tid","addEventListener","uidDemo","Utils","randomUUID","uidLegacy","uidPreview","div","toast","join","waitForElementById","elem","handler","img","uploader","fireLoad","ImgAny","decodeAlt","xhr","XMLHttpRequest","open","responseType","onprogress","evt","fireProgress","loaded","total","onloadend","createImageBitmap","response","then","o","meta","Object","assign","createElement","content","head","appendChild","remove","setNoReferrer","send","dispatchEvent","Event","location","replace"],"mappings":"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"}