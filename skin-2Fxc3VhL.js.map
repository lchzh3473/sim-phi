{"version":3,"file":"skin-2Fxc3VhL.js","sources":["../src/plugins/skin.js"],"sourcesContent":["import { stringify } from '@/utils/stringify';\nimport { waitForElementById } from '@/utils/waitForElementById';\nexport default hook.define({\n  name: 'Skin',\n  description: 'Customize skin',\n  contents: [\n    {\n      type: 'script',\n      meta: [$ => fireTip($('#btn-play'))]\n    }\n  ]\n});\nconst { audio } = hook;\nfunction skin() {\n  const id = `skin${Date.now()}`;\n  /** @type {ByteData[]} */\n  const files = [];\n  const zip = new hook.ZipReader({ handler: data => files.push(data) });\n  zip.addEventListener('loadstart', () => hook.sendText('加载zip组件...'));\n  zip.addEventListener('read', () => hook.handleFile(id, zip.total, null, done));\n  const uid = Utils.randomUUID();\n  const div = hook.fireModal('<p>皮肤选择器</p>', `<p><a id=\"${uid}\" href=\"#\">点击此处上传文件</a></p>`);\n  const input = Object.assign(document.createElement('input'), {\n    type: 'file',\n    accept: '',\n    /** @this {HTMLInputElement} */\n    onchange() {\n      if (!this.files) return;\n      const file = this.files[0];\n      const reader = new FileReader();\n      reader.readAsArrayBuffer(file);\n      reader.onload = evt => {\n        if (!evt.target || !(evt.target.result instanceof ArrayBuffer)) return;\n        zip.read({\n          pathname: file.webkitRelativePath || file.name,\n          buffer: evt.target.result\n        });\n        div.dispatchEvent(new Event('custom-done'));\n      };\n    }\n  });\n  // 直到uid进入DOM树才能触发click事件\n  waitForElementById(uid, elem => {\n    elem.addEventListener('click', () => input.click());\n  });\n  // input.click();\n  async function done() {\n    console.log(files);\n    const config = Object.create(await loadConfig(files));\n    /** @type {Object<string, string[]>} */\n    const alias = {\n      Tap: ['Tap.png', 'click.png'],\n      TapHL: ['TapHL.png', 'click_mh.png'],\n      Drag: ['Drag.png', 'drag.png'],\n      DragHL: ['DragHL.png', 'drag_mh.png'],\n      Hold: ['Hold.png', 'hold.png'],\n      HoldHL: ['HoldHL.png', 'hold_mh.png'],\n      Flick: ['Flick.png', 'flick.png'],\n      FlickHL: ['FlickHL.png', 'flick_mh.png'],\n      HitFX: ['HitFX.png', 'hit_fx.png'],\n      HitSong0: ['HitSong0.ogg', 'Tap.ogg', 'click.ogg'],\n      HitSong1: ['HitSong1.ogg', 'Drag.ogg', 'drag.ogg'],\n      HitSong2: ['HitSong2.ogg', 'Flick.ogg', 'flick.ogg']\n    };\n    // 根据别名补全文件列表\n    /** @type {Map<string, ByteData>} */\n    const entries = new Map();\n    for (const [a, b] of Object.entries(alias)) {\n      for (const i of b) {\n        const file = files.find(j => String(j.pathname).endsWith(i));\n        if (file) {\n          entries.set(a, file);\n          break;\n        }\n      }\n    }\n    // 读取图片\n    if (entries.has('Tap')) {\n      const img = await createImageBitmap(new Blob([entries.get('Tap').buffer]));\n      const noteScale = 1089 / img.width;\n      hook.noteRender.update('Tap', img, noteScale);\n      if (entries.has('TapHL')) {\n        hook.noteRender.update('TapHL', await createImageBitmap(new Blob([entries.get('TapHL').buffer])), noteScale);\n      } else {\n        hook.noteRender.update('TapHL', img, noteScale);\n      }\n    }\n    if (entries.has('Drag')) {\n      const img = await createImageBitmap(new Blob([entries.get('Drag').buffer]));\n      const noteScale = 1089 / img.width;\n      hook.noteRender.update('Drag', img, noteScale);\n      if (entries.has('DragHL')) {\n        hook.noteRender.update('DragHL', await createImageBitmap(new Blob([entries.get('DragHL').buffer])), noteScale);\n      } else {\n        hook.noteRender.update('DragHL', img, noteScale);\n      }\n    }\n    if (entries.has('Hold')) {\n      const img = await createImageBitmap(new Blob([entries.get('Hold').buffer]));\n      const noteScale = 1089 / img.width;\n      const [bottom, top] = config.holdAtlas;\n      const imgHoldEnd = bottom ? await createImageBitmap(img, 0, 0, img.width, bottom) : hook.res.NoImageBlack;\n      const imgHold = await createImageBitmap(img, 0, bottom, img.width, img.height - bottom - top);\n      const imgHoldHead = top ? await createImageBitmap(img, 0, img.height - top, img.width, top) : hook.res.NoImageBlack;\n      const compacted = config.holdCompact;\n      hook.noteRender.update('HoldEnd', imgHoldEnd, noteScale, compacted);\n      hook.noteRender.update('Hold', imgHold, noteScale, compacted);\n      hook.noteRender.update('HoldHead', imgHoldHead, noteScale, compacted);\n      if (entries.has('HoldHL')) {\n        const img2 = await createImageBitmap(new Blob([entries.get('HoldHL').buffer]));\n        const [bottom2, top2] = config.holdAtlasHL || config.holdAtlasMH || config.holdAtlas;\n        const imgHoldEndHL = bottom2 ? await createImageBitmap(img2, 0, 0, img2.width, bottom2) : hook.res.NoImageBlack;\n        const imgHoldHL = await createImageBitmap(img2, 0, bottom2, img2.width, img2.height - bottom2 - top2);\n        const imgHoldHeadHL = top2 ? await createImageBitmap(img2, 0, img2.height - top2, img2.width, top2) : hook.res.NoImageBlack;\n        hook.noteRender.update('HoldEndHL', imgHoldEndHL, noteScale, compacted);\n        hook.noteRender.update('HoldHL', imgHoldHL, noteScale, compacted);\n        hook.noteRender.update('HoldHeadHL', imgHoldHeadHL, noteScale, compacted);\n      } else {\n        hook.noteRender.update('HoldEndHL', imgHoldEnd, noteScale, compacted);\n        hook.noteRender.update('HoldHL', imgHold, noteScale, compacted);\n        hook.noteRender.update('HoldHeadHL', imgHoldHead, noteScale, compacted);\n      }\n    }\n    if (entries.has('Flick')) {\n      const img = await createImageBitmap(new Blob([entries.get('Flick').buffer]));\n      const noteScale = 1089 / img.width;\n      hook.noteRender.update('Flick', img, noteScale);\n      if (entries.has('FlickHL')) {\n        hook.noteRender.update('FlickHL', await createImageBitmap(new Blob([entries.get('FlickHL').buffer])), noteScale);\n      } else {\n        hook.noteRender.update('FlickHL', img, noteScale);\n      }\n    }\n    if (entries.has('HitFX')) {\n      const img = await createImageBitmap(new Blob([entries.get('HitFX').buffer]));\n      const [x, y] = config.hitFx;\n      const scale = (config.hitFxScale || 1.0) / (img.width / x / 256);\n      const hideParts = config.hideParticles || false;\n      const duration = config.hitFxDuration * 1000 || 500;\n      hook.noteRender.updateFX(img, scale, img.width / x, img.height / y, hideParts, duration);\n    }\n    // 读取音频\n    if (entries.has('HitSong0')) hook.res.HitSong0 = await audio.decode(entries.get('HitSong0').buffer.slice(0));\n    if (entries.has('HitSong1')) hook.res.HitSong1 = await audio.decode(entries.get('HitSong1').buffer.slice(0));\n    if (entries.has('HitSong2')) hook.res.HitSong2 = await audio.decode(entries.get('HitSong2').buffer.slice(0));\n    console.log(config, entries);\n  }\n}\n/** @param {ByteData[]} files */\nfunction loadConfig(files = []) {\n  const config0 = files.find(i => String(i.pathname).endsWith('config.txt'));\n  if (config0) return parseYAML(stringify(config0.buffer), /;?\\r?\\n/);\n  const config1 = files.find(i => String(i.pathname).endsWith('info.yml'));\n  if (config1) return parseYAML(stringify(config1.buffer));\n  hook.sendError('未找到config.txt或info.yml');\n  return {};\n}\nfunction parseYAML(text = '', split = /\\r?\\n/) {\n  /** @type {(value:string)=>any} */\n  const parse = value => {\n    try {\n      return JSON.parse(value);\n    } catch (ignoreErr) {\n      return value;\n    }\n  };\n  return text.split(split).reduce((i, j) => {\n    const [key, value] = j.split(/:(.+)/).map(s => s.trim());\n    if (key) i[key] = parse(value);\n    if (i[key] === 'True') i[key] = true;\n    if (i[key] === 'False') i[key] = false;\n    return i;\n  }, Object.create(null));\n}\nfunction fireTip(elem) {\n  /**\n   * @param {HTMLElement} elem1\n   * @param {()=>any} activeFn\n   * @param {()=>any} doneFn\n   */\n  function longPress(elem1, activeFn, doneFn, failFn) {\n    let timer = null;\n    elem1.addEventListener('mousedown', onrequest);\n    elem1.addEventListener('mouseup', oncancel);\n    elem1.addEventListener('mouseleave', oncancel);\n    elem1.addEventListener('touchstart', onrequest, { passive: true });\n    elem1.addEventListener('touchend', oncancel);\n    elem1.addEventListener('touchcancel', oncancel);\n    function onrequest() {\n      timer = requestAnimationFrame(onrequest);\n      if (activeFn()) {\n        cancelAnimationFrame(timer);\n        doneFn();\n        elem1.removeEventListener('mousedown', onrequest);\n        elem1.removeEventListener('mouseup', oncancel);\n        elem1.removeEventListener('mouseleave', oncancel);\n        elem1.removeEventListener('touchstart', onrequest);\n        elem1.removeEventListener('touchend', oncancel);\n        elem1.removeEventListener('touchcancel', oncancel);\n      }\n    }\n    function oncancel() {\n      cancelAnimationFrame(timer);\n      failFn();\n    }\n  }\n  (function helloworld() {\n    let pressTime = null;\n    longPress(elem, () => {\n      if (pressTime == null) pressTime = performance.now();\n      if (performance.now() - pressTime > 1000) return 1;\n      return 0;\n    }, () => {\n      skin();\n      helloworld();\n    }, () => pressTime = null);\n  }());\n}\n"],"names":["skin","hook","define","name","description","contents","type","meta","$","elem","helloworld","pressTime","elem1","activeFn","doneFn","failFn","timer","onrequest","requestAnimationFrame","cancelAnimationFrame","removeEventListener","oncancel","addEventListener","passive","longPress","performance","now","id","Date","files","zip","ZipReader","handler","data","push","sendText","handleFile","total","done","uid","Utils","randomUUID","div","fireModal","input","Object","assign","document","createElement","accept","onchange","this","file","reader","FileReader","readAsArrayBuffer","onload","evt","target","result","ArrayBuffer","read","pathname","webkitRelativePath","buffer","dispatchEvent","Event","async","console","log","config","create","config0","find","i","String","endsWith","parseYAML","stringify","config1","sendError","loadConfig","alias","Tap","TapHL","Drag","DragHL","Hold","HoldHL","Flick","FlickHL","HitFX","HitSong0","HitSong1","HitSong2","entries","Map","a","b","j","set","has","img","createImageBitmap","Blob","get","noteScale","width","noteRender","update","bottom","top","holdAtlas","imgHoldEnd","res","NoImageBlack","imgHold","height","imgHoldHead","compacted","holdCompact","img2","bottom2","top2","holdAtlasHL","holdAtlasMH","imgHoldEndHL","imgHoldHL","imgHoldHeadHL","x","y","hitFx","scale","hitFxScale","hideParts","hideParticles","duration","hitFxDuration","updateFX","audio","decode","slice","waitForElementById","click","fireTip","text","split","reduce","key","value","map","s","trim","JSON","parse"],"mappings":"6FAEA,MAAeA,EAAAC,KAAKC,OAAO,CACzBC,KAAM,OACNC,YAAa,iBACbC,SAAU,CACR,CACEC,KAAM,SACNC,KAAM,CAACC,GAsKb,SAAiBC,IAgCf,SAAUC,IACR,IAAIC,EAAY,MA3BlB,SAAmBC,EAAOC,EAAUC,EAAQC,GAC1C,IAAIC,EAAQ,KAOZ,SAASC,IACPD,EAAQE,sBAAsBD,GAC1BJ,MACFM,qBAAqBH,GACrBF,IACAF,EAAMQ,oBAAoB,YAAaH,GACvCL,EAAMQ,oBAAoB,UAAWC,GACrCT,EAAMQ,oBAAoB,aAAcC,GACxCT,EAAMQ,oBAAoB,aAAcH,GACxCL,EAAMQ,oBAAoB,WAAYC,GACtCT,EAAMQ,oBAAoB,cAAeC,GAEjD,CACI,SAASA,IACcL,qBAAAA,GACrBD,GACN,CAtBIH,EAAMU,iBAAiB,YAAaL,GACpCL,EAAMU,iBAAiB,UAAWD,GAClCT,EAAMU,iBAAiB,aAAcD,GACrCT,EAAMU,iBAAiB,aAAcL,EAAW,CAAEM,SAAS,IAC3DX,EAAMU,iBAAiB,WAAYD,GACnCT,EAAMU,iBAAiB,cAAeD,EAkB1C,CAGIG,CAAUf,GAAM,KACG,MAAbE,IAAmBA,EAAYc,YAAYC,OAC3CD,YAAYC,MAAQf,EAAY,IAAa,EAC1C,KACN,MAvMP,WACQgB,MAAAA,EAAK,OAAOC,KAAKF,QAEjBG,EAAQ,GACRC,EAAM,IAAI7B,KAAK8B,UAAU,CAAEC,QAASC,GAAQJ,EAAMK,KAAKD,KAC7DH,EAAIR,iBAAiB,aAAa,IAAMrB,KAAKkC,SAAS,gBACtDL,EAAIR,iBAAiB,QAAQ,IAAMrB,KAAKmC,WAAWT,EAAIG,EAAIO,MAAO,KAAMC,KACxE,MAAMC,EAAMC,MAAMC,aACZC,EAAMzC,KAAK0C,UAAU,eAAgB,aAAaJ,gCAClDK,EAAQC,OAAOC,OAAOC,SAASC,cAAc,SAAU,CAC3D1C,KAAM,OACN2C,OAAQ,GAERC,QAAAA,GACM,IAACC,KAAKtB,MAAO,OACjB,MAAMuB,EAAOD,KAAKtB,MAAM,GAClBwB,EAAS,IAAIC,WACnBD,EAAOE,kBAAkBH,GACzBC,EAAOG,OAASC,KACTA,EAAIC,UAAYD,EAAIC,OAAOC,kBAAkBC,eAClD9B,EAAI+B,KAAK,CACPC,SAAUV,EAAKW,oBAAsBX,EAAKjD,KAC1C6D,OAAQP,EAAIC,OAAOC,SAErBjB,EAAIuB,cAAc,IAAIC,MAAM,gBAAc,CAElD,IAOEC,eAAe7B,IACb8B,QAAQC,IAAIxC,GACNyC,MAAAA,EAASzB,OAAO0B,aAqG1B,SAAoB1C,EAAQ,IACpB2C,MAAAA,EAAU3C,EAAM4C,MAAUC,GAAAC,OAAOD,EAAEZ,UAAUc,SAAS,gBAC5D,GAAIJ,EAAgBK,OAAAA,EAAUC,EAAUN,EAAQR,QAAS,WACnDe,MAAAA,EAAUlD,EAAM4C,MAAUC,GAAAC,OAAOD,EAAEZ,UAAUc,SAAS,cACxDG,OAAAA,EAAgBF,EAAUC,EAAUC,EAAQf,UAChD/D,KAAK+E,UAAU,0BACR,CAAE,EACX,CA5GuCC,CAAWpD,IAExCqD,EAAQ,CACZC,IAAK,CAAC,UAAW,aACjBC,MAAO,CAAC,YAAa,gBACrBC,KAAM,CAAC,WAAY,YACnBC,OAAQ,CAAC,aAAc,eACvBC,KAAM,CAAC,WAAY,YACnBC,OAAQ,CAAC,aAAc,eACvBC,MAAO,CAAC,YAAa,aACrBC,QAAS,CAAC,cAAe,gBACzBC,MAAO,CAAC,YAAa,cACrBC,SAAU,CAAC,eAAgB,UAAW,aACtCC,SAAU,CAAC,eAAgB,WAAY,YACvCC,SAAU,CAAC,eAAgB,YAAa,cAIpCC,EAAU,IAAIC,IACpB,IAAA,MAAYC,EAAGC,KAAMrD,OAAOkD,QAAQb,GAClC,IAAA,MAAWR,KAAKwB,EAAG,CACX9C,MAAAA,EAAOvB,EAAM4C,MAAK0B,GAAKxB,OAAOwB,EAAErC,UAAUc,SAASF,KACzD,GAAItB,EAAM,CACR2C,EAAQK,IAAIH,EAAG7C,GACf,KACV,CACA,CAGQ2C,GAAAA,EAAQM,IAAI,OAAQ,CACtB,MAAMC,QAAYC,kBAAkB,IAAIC,KAAK,CAACT,EAAQU,IAAI,OAAOzC,UAC3D0C,EAAY,KAAOJ,EAAIK,MAC7B1G,KAAK2G,WAAWC,OAAO,MAAOP,EAAKI,GAC/BX,EAAQM,IAAI,SACdpG,KAAK2G,WAAWC,OAAO,cAAeN,kBAAkB,IAAIC,KAAK,CAACT,EAAQU,IAAI,SAASzC,UAAW0C,GAElGzG,KAAK2G,WAAWC,OAAO,QAASP,EAAKI,EAE7C,CACQX,GAAAA,EAAQM,IAAI,QAAS,CACvB,MAAMC,QAAYC,kBAAkB,IAAIC,KAAK,CAACT,EAAQU,IAAI,QAAQzC,UAC5D0C,EAAY,KAAOJ,EAAIK,MAC7B1G,KAAK2G,WAAWC,OAAO,OAAQP,EAAKI,GAChCX,EAAQM,IAAI,UACdpG,KAAK2G,WAAWC,OAAO,eAAgBN,kBAAkB,IAAIC,KAAK,CAACT,EAAQU,IAAI,UAAUzC,UAAW0C,GAEpGzG,KAAK2G,WAAWC,OAAO,SAAUP,EAAKI,EAE9C,CACQX,GAAAA,EAAQM,IAAI,QAAS,CACvB,MAAMC,QAAYC,kBAAkB,IAAIC,KAAK,CAACT,EAAQU,IAAI,QAAQzC,UAC5D0C,EAAY,KAAOJ,EAAIK,OACtBG,EAAQC,GAAOzC,EAAO0C,UACvBC,EAAaH,QAAeP,kBAAkBD,EAAK,EAAG,EAAGA,EAAIK,MAAOG,GAAU7G,KAAKiH,IAAIC,aACvFC,QAAgBb,kBAAkBD,EAAK,EAAGQ,EAAQR,EAAIK,MAAOL,EAAIe,OAASP,EAASC,GACnFO,EAAcP,QAAYR,kBAAkBD,EAAK,EAAGA,EAAIe,OAASN,EAAKT,EAAIK,MAAOI,GAAO9G,KAAKiH,IAAIC,aACjGI,EAAYjD,EAAOkD,YACzB,GAAAvH,KAAK2G,WAAWC,OAAO,UAAWI,EAAYP,EAAWa,GACzDtH,KAAK2G,WAAWC,OAAO,OAAQO,EAASV,EAAWa,GACnDtH,KAAK2G,WAAWC,OAAO,WAAYS,EAAaZ,EAAWa,GACvDxB,EAAQM,IAAI,UAAW,CACzB,MAAMoB,QAAalB,kBAAkB,IAAIC,KAAK,CAACT,EAAQU,IAAI,UAAUzC,WAC9D0D,EAASC,GAAQrD,EAAOsD,aAAetD,EAAOuD,aAAevD,EAAO0C,UACrEc,EAAeJ,QAAgBnB,kBAAkBkB,EAAM,EAAG,EAAGA,EAAKd,MAAOe,GAAWzH,KAAKiH,IAAIC,aAC7FY,QAAkBxB,kBAAkBkB,EAAM,EAAGC,EAASD,EAAKd,MAAOc,EAAKJ,OAASK,EAAUC,GAC1FK,EAAgBL,QAAapB,kBAAkBkB,EAAM,EAAGA,EAAKJ,OAASM,EAAMF,EAAKd,MAAOgB,GAAQ1H,KAAKiH,IAAIC,aAC1GlH,KAAA2G,WAAWC,OAAO,YAAaiB,EAAcpB,EAAWa,GAC7DtH,KAAK2G,WAAWC,OAAO,SAAUkB,EAAWrB,EAAWa,GACvDtH,KAAK2G,WAAWC,OAAO,aAAcmB,EAAetB,EAAWa,EACvE,MACatH,KAAA2G,WAAWC,OAAO,YAAaI,EAAYP,EAAWa,GAC3DtH,KAAK2G,WAAWC,OAAO,SAAUO,EAASV,EAAWa,GACrDtH,KAAK2G,WAAWC,OAAO,aAAcS,EAAaZ,EAAWa,EAErE,CACQxB,GAAAA,EAAQM,IAAI,SAAU,CACxB,MAAMC,QAAYC,kBAAkB,IAAIC,KAAK,CAACT,EAAQU,IAAI,SAASzC,UAC7D0C,EAAY,KAAOJ,EAAIK,MAC7B1G,KAAK2G,WAAWC,OAAO,QAASP,EAAKI,GACjCX,EAAQM,IAAI,WACdpG,KAAK2G,WAAWC,OAAO,gBAAiBN,kBAAkB,IAAIC,KAAK,CAACT,EAAQU,IAAI,WAAWzC,UAAW0C,GAEtGzG,KAAK2G,WAAWC,OAAO,UAAWP,EAAKI,EAE/C,CACQX,GAAAA,EAAQM,IAAI,SAAU,CACxB,MAAMC,QAAYC,kBAAkB,IAAIC,KAAK,CAACT,EAAQU,IAAI,SAASzC,WAC5DiE,EAAGC,GAAK5D,EAAO6D,MAChBC,GAAS9D,EAAO+D,YAAc,IAAQ/B,EAAIK,MAAQsB,EAAI,KACtDK,EAAYhE,EAAOiE,gBAAiB,EACpCC,EAAkC,IAAvBlE,EAAOmE,eAAwB,IAC3CxI,KAAA2G,WAAW8B,SAASpC,EAAK8B,EAAO9B,EAAIK,MAAQsB,EAAG3B,EAAIe,OAASa,EAAGI,EAAWE,EACrF,CAEQzC,EAAQM,IAAI,cAAapG,KAAKiH,IAAItB,eAAiB+C,EAAMC,OAAO7C,EAAQU,IAAI,YAAYzC,OAAO6E,MAAM,KACrG9C,EAAQM,IAAI,cAAapG,KAAKiH,IAAIrB,eAAiB8C,EAAMC,OAAO7C,EAAQU,IAAI,YAAYzC,OAAO6E,MAAM,KACrG9C,EAAQM,IAAI,cAAapG,KAAKiH,IAAIpB,eAAiB6C,EAAMC,OAAO7C,EAAQU,IAAI,YAAYzC,OAAO6E,MAAM,KACzGzE,QAAQC,IAAIC,EAAQyB,EACxB,CAxGE+C,EAAmBvG,GAAK9B,IACtBA,EAAKa,iBAAiB,SAAS,IAAMsB,EAAMmG,SAAO,GAwGtD,EAkEM/I,GACAU,GAAY,IACX,IAAMC,EAAY,MACpB,CAVH,EAWF,CAjNkBqI,CAAQxI,EAAE,oBAIpBmI,MAAAA,GAAU1I,KAiJlB,SAAS4E,EAAUoE,EAAO,GAAIC,EAAQ,SASpC,OAAOD,EAAKC,MAAMA,GAAOC,QAAO,CAACzE,EAAGyB,KAClC,MAAOiD,EAAKC,GAASlD,EAAE+C,MAAM,SAASI,KAAIC,GAAKA,EAAEC,SAC7CJ,OAAAA,IAAK1E,EAAE0E,GATCC,KACR,IACK,OAAAI,KAAKC,MAAML,EACnB,CAAmB,MACXA,OAAAA,CACb,GAIsBK,CAAML,IACT,SAAX3E,EAAE0E,KAAiB1E,EAAE0E,IAAO,GACjB,UAAX1E,EAAE0E,KAAkB1E,EAAE0E,IAAO,GAC1B1E,CAAA,GACN7B,OAAO0B,OAAO,MACnB"}