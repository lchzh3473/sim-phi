{"version":3,"file":"skin-de256007.js","sources":["../src/plugins/skin.js"],"sourcesContent":["import { stringify } from '../utils/stringify';\nimport { waitForElementById } from '../utils/waitForElementById';\nimport { audio } from '../external';\nexport default hook.define({\n  name: 'Skin',\n  description: 'Customize skin',\n  contents: [\n    {\n      type: 'command',\n      meta: ['/skin', skin]\n    }\n  ]\n});\nfunction skin() {\n  const id = `skin${Date.now()}`;\n  /** @type {ByteData[]} */\n  const files = [];\n  const zip = new hook.ZipReader({ handler: data => files.push(data) });\n  zip.addEventListener('loadstart', () => hook.sendText('加载zip组件...'));\n  zip.addEventListener('read', () => hook.handleFile(id, zip.total, null, done));\n  const uid = Utils.randomUUID();\n  const div = hook.toast(`<a id=\"${uid}\" href=\"#\">点击此处打开文件选择器</a>`);\n  const input = Object.assign(document.createElement('input'), {\n    type: 'file',\n    accept: '',\n    /** @this {HTMLInputElement} */\n    onchange() {\n      if (!this.files) return;\n      const file = this.files[0];\n      const reader = new FileReader();\n      reader.readAsArrayBuffer(file);\n      reader.onload = evt => {\n        if (!evt.target || !(evt.target.result instanceof ArrayBuffer)) return;\n        zip.read({\n          name: file.name,\n          buffer: evt.target.result,\n          path: file.webkitRelativePath || file.name\n        });\n        div.dispatchEvent(new Event('custom-done'));\n      };\n    }\n  });\n  // 直到uid进入DOM树才能触发click事件\n  waitForElementById(uid, elem => {\n    elem.addEventListener('click', () => input.click());\n  });\n  // input.click();\n  async function done() {\n    console.log(files);\n    const config = Object.create(await loadConfig(files));\n    /** @type {Object<string, string[]>} */\n    const alias = {\n      Tap: ['Tap.png', 'click.png'],\n      TapHL: ['TapHL.png', 'click_mh.png'],\n      Drag: ['Drag.png', 'drag.png'],\n      DragHL: ['DragHL.png', 'drag_mh.png'],\n      Hold: ['Hold.png', 'hold.png'],\n      HoldHL: ['HoldHL.png', 'hold_mh.png'],\n      Flick: ['Flick.png', 'flick.png'],\n      FlickHL: ['FlickHL.png', 'flick_mh.png'],\n      HitFX: ['HitFX.png', 'hit_fx.png'],\n      HitSong0: ['HitSong0.ogg', 'Tap.ogg', 'click.ogg'],\n      HitSong1: ['HitSong1.ogg', 'Drag.ogg', 'drag.ogg'],\n      HitSong2: ['HitSong2.ogg', 'Flick.ogg', 'flick.ogg']\n    };\n    // 根据别名补全文件列表\n    /** @type {Map<string, ByteData>} */\n    const entries = new Map();\n    for (const [a, b] of Object.entries(alias)) {\n      for (const i of b) {\n        const file = files.find(j => String(j.name).endsWith(i));\n        if (file) {\n          entries.set(a, file);\n          break;\n        }\n      }\n    }\n    // 读取图片\n    if (entries.has('Tap')) {\n      const img = await createImageBitmap(new Blob([entries.get('Tap').buffer]));\n      const noteScale = 1089 / img.width;\n      hook.noteRender.update('Tap', img, noteScale);\n      if (entries.has('TapHL')) {\n        hook.noteRender.update('TapHL', await createImageBitmap(new Blob([entries.get('TapHL').buffer])), noteScale);\n      } else {\n        hook.noteRender.update('TapHL', img, noteScale);\n      }\n    }\n    if (entries.has('Drag')) {\n      const img = await createImageBitmap(new Blob([entries.get('Drag').buffer]));\n      const noteScale = 1089 / img.width;\n      hook.noteRender.update('Drag', img, noteScale);\n      if (entries.has('DragHL')) {\n        hook.noteRender.update('DragHL', await createImageBitmap(new Blob([entries.get('DragHL').buffer])), noteScale);\n      } else {\n        hook.noteRender.update('DragHL', img, noteScale);\n      }\n    }\n    if (entries.has('Hold')) {\n      const img = await createImageBitmap(new Blob([entries.get('Hold').buffer]));\n      const noteScale = 1089 / img.width;\n      const [bottom, top] = config.holdAtlas;\n      const compacted = config.holdCompact;\n      hook.noteRender.update('HoldEnd', await createImageBitmap(img, 0, 0, img.width, bottom), noteScale, compacted);\n      hook.noteRender.update('Hold', await createImageBitmap(img, 0, bottom, img.width, img.height - bottom - top), noteScale, compacted);\n      hook.noteRender.update('HoldHead', await createImageBitmap(img, 0, img.height - top, img.width, top), noteScale, compacted);\n      if (entries.has('HoldHL')) {\n        const img2 = await createImageBitmap(new Blob([entries.get('HoldHL').buffer]));\n        const [bottom2, top2] = config.holdAtlasHL || config.holdAtlasMH || config.holdAtlas;\n        hook.noteRender.update('HoldEndHL', await createImageBitmap(img2, 0, 0, img2.width, bottom2), noteScale, compacted);\n        hook.noteRender.update('HoldHL', await createImageBitmap(img2, 0, bottom2, img2.width, img2.height - bottom2 - top2), noteScale, compacted);\n        hook.noteRender.update('HoldHeadHL', await createImageBitmap(img2, 0, img2.height - top2, img2.width, top2), noteScale, compacted);\n      } else {\n        hook.noteRender.update('HoldEndHL', await createImageBitmap(img, 0, 0, img.width, bottom), noteScale, compacted);\n        hook.noteRender.update('HoldHL', await createImageBitmap(img, 0, bottom, img.width, img.height - bottom - top), noteScale, compacted);\n        hook.noteRender.update('HoldHeadHL', await createImageBitmap(img, 0, img.height - top, img.width, top), noteScale, compacted);\n      }\n    }\n    if (entries.has('Flick')) {\n      const img = await createImageBitmap(new Blob([entries.get('Flick').buffer]));\n      const noteScale = 1089 / img.width;\n      hook.noteRender.update('Flick', img, noteScale);\n      if (entries.has('FlickHL')) {\n        hook.noteRender.update('FlickHL', await createImageBitmap(new Blob([entries.get('FlickHL').buffer])), noteScale);\n      } else {\n        hook.noteRender.update('FlickHL', img, noteScale);\n      }\n    }\n    if (entries.has('HitFX')) {\n      const img = await createImageBitmap(new Blob([entries.get('HitFX').buffer]));\n      const [x, y] = config.hitFx;\n      const scale = (config.hitFxScale || 1.0) / (img.width / x / 256);\n      const hideParts = config.hideParticles || false;\n      const duration = config.hitFxDuration * 1000 || 500;\n      hook.noteRender.updateFX(img, scale, img.width / x, img.height / y, hideParts, duration);\n    }\n    // 读取音频\n    if (entries.has('HitSong0')) hook.res.HitSong0 = await audio.decode(entries.get('HitSong0').buffer.slice(0));\n    if (entries.has('HitSong1')) hook.res.HitSong1 = await audio.decode(entries.get('HitSong1').buffer.slice(0));\n    if (entries.has('HitSong2')) hook.res.HitSong2 = await audio.decode(entries.get('HitSong2').buffer.slice(0));\n    console.log(config, entries);\n  }\n}\n/** @param {ByteData[]} files */\nfunction loadConfig(files = []) {\n  const config0 = files.find(i => String(i.name).endsWith('config.txt'));\n  if (config0) return parseYAML(stringify(config0.buffer), /;?\\r?\\n/);\n  const config1 = files.find(i => String(i.name).endsWith('info.yml'));\n  if (config1) return parseYAML(stringify(config1.buffer));\n  hook.sendError('未找到config.txt或info.yml');\n  return {};\n}\nfunction parseYAML(text = '', split = /\\r?\\n/) {\n  /** @type {(value:string)=>any} */\n  const parse = value => {\n    try {\n      return JSON.parse(value);\n    } catch (e) {\n      return value;\n    }\n  };\n  return text.split(split).reduce((i, j) => {\n    const [key, value] = j.split(/:(.+)/).map(s => s.trim());\n    if (key) i[key] = parse(value);\n    if (i[key] === 'True') i[key] = true;\n    if (i[key] === 'False') i[key] = false;\n    return i;\n  }, Object.create(null));\n}\n"],"names":["skin","hook","define","name","description","contents","type","meta","id","Date","now","files","zip","ZipReader","handler","data","push","addEventListener","sendText","handleFile","total","done","uid","Utils","randomUUID","div","toast","input","Object","assign","document","createElement","accept","onchange","this","file","reader","FileReader","readAsArrayBuffer","onload","evt","target","result","ArrayBuffer","read","buffer","path","webkitRelativePath","dispatchEvent","Event","async","console","log","config","create","config0","find","i","String","endsWith","parseYAML","stringify","config1","sendError","loadConfig","alias","Tap","TapHL","Drag","DragHL","Hold","HoldHL","Flick","FlickHL","HitFX","HitSong0","HitSong1","HitSong2","entries","Map","a","b","j","set","has","img","createImageBitmap","Blob","get","noteScale","width","noteRender","update","bottom","top","holdAtlas","compacted","holdCompact","height","img2","bottom2","top2","holdAtlasHL","holdAtlasMH","x","y","hitFx","scale","hitFxScale","hideParts","hideParticles","duration","hitFxDuration","updateFX","res","audio","decode","slice","waitForElementById","elem","click","text","split","reduce","key","value","map","s","trim","JSON","parse"],"mappings":"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"}