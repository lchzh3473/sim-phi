{"version":3,"file":"reverse-U_9HVu8A.js","sources":["../src/plugins/demo/reverse.js"],"sourcesContent":["// 规范判定线事件\nfunction arrangeLineEvent(events) {\n  const oldEvents = JSON.parse(JSON.stringify(events)); // 深拷贝\n  const newEvents = [\n    {\n      // 以1-1e6开头\n      startTime: 1 - 1e6,\n      endTime: 0,\n      start: oldEvents[0] ? oldEvents[0].start : 0,\n      end: oldEvents[0] ? oldEvents[0].start : 0,\n      start2: oldEvents[0] ? oldEvents[0].start2 : 0,\n      end2: oldEvents[0] ? oldEvents[0].start2 : 0\n    }\n  ];\n  oldEvents.push({\n    // 以1e9结尾\n    startTime: 0,\n    endTime: 1e9,\n    start: oldEvents[oldEvents.length - 1] ? oldEvents[oldEvents.length - 1].end : 0,\n    end: oldEvents[oldEvents.length - 1] ? oldEvents[oldEvents.length - 1].end : 0,\n    start2: oldEvents[oldEvents.length - 1] ? oldEvents[oldEvents.length - 1].end2 : 0,\n    end2: oldEvents[oldEvents.length - 1] ? oldEvents[oldEvents.length - 1].end2 : 0\n  });\n  for (const i2 of oldEvents) {\n    // 保证时间连续性\n    const i1 = newEvents[newEvents.length - 1];\n    if (i2.startTime > i2.endTime) continue;\n    if (i1.endTime > i2.endTime) {\n      // i1吃掉i2\n    } else if (i1.endTime === i2.startTime) newEvents.push(i2);\n    else if (i1.endTime < i2.startTime) {\n      newEvents.push({\n        startTime: i1.endTime,\n        endTime: i2.startTime,\n        start: i1.end,\n        end: i1.end,\n        start2: i1.end2,\n        end2: i1.end2\n      }, i2);\n    } else if (i1.endTime > i2.startTime) {\n      newEvents.push({\n        startTime: i1.endTime,\n        endTime: i2.endTime,\n        start: (i2.start * (i2.endTime - i1.endTime) + i2.end * (i1.endTime - i2.startTime)) / (i2.endTime - i2.startTime),\n        end: i1.end,\n        start2: (i2.start2 * (i2.endTime - i1.endTime) + i2.end2 * (i1.endTime - i2.startTime)) / (i2.endTime - i2.startTime),\n        end2: i1.end2\n      });\n    }\n  }\n  // 合并相同变化率事件\n  const newEvents2 = [newEvents.shift()];\n  for (const i2 of newEvents) {\n    const i1 = newEvents2[newEvents2.length - 1];\n    const d1 = i1.endTime - i1.startTime;\n    const d2 = i2.endTime - i2.startTime;\n    if (i2.startTime === i2.endTime) {\n      // 忽略0长度事件\n    } else if (i1.end === i2.start && i1.end2 === i2.start2 && (i1.end - i1.start) * d2 === (i2.end - i2.start) * d1 && (i1.end2 - i1.start2) * d2 === (i2.end2 - i2.start2) * d1) {\n      i1.endTime = i2.endTime;\n      i1.end = i2.end;\n      i1.end2 = i2.end2;\n    } else newEvents2.push(i2);\n  }\n  return JSON.parse(JSON.stringify(newEvents2));\n}\nfunction reverseLineEvent(evt, tb) {\n  const start = evt.end;\n  evt.end = evt.start;\n  evt.start = start;\n  const start2 = evt.end2;\n  evt.end2 = evt.start2;\n  evt.start2 = start2;\n  const startTime = tb - evt.endTime;\n  evt.endTime = tb - evt.startTime;\n  evt.startTime = startTime;\n}\nfunction reverseNote(note, tb) {\n  note.time = tb - note.time;\n  if (note.type === 3) {\n    note.speed *= note.holdTime;\n    note.holdTime = 1;\n  }\n}\nfunction reverseSpeedEvent(evt, tb) {\n  const startTime = tb - evt.endTime;\n  evt.endTime = tb - evt.startTime;\n  evt.startTime = startTime;\n}\nfunction updateSefp(line) {\n  let y = 0;\n  line.speedEvents.sort((a, b) => a.startTime - b.startTime);\n  for (const evt of line.speedEvents) {\n    if (evt.startTime < 0) evt.startTime = 0;\n    evt.floorPosition = y;\n    y += (evt.endTime - evt.startTime) * evt.value / line.bpm * 1.875;\n  }\n  line.speedEvents[line.speedEvents.length - 1].endTime = 1e9;\n  for (const note of line.notesAbove) {\n    let owo = 0;\n    let owo2 = 0;\n    let owo3 = 0;\n    for (const evt of line.speedEvents) {\n      if (note.time % 1e9 > evt.endTime) continue;\n      if (note.time % 1e9 < evt.startTime) break;\n      owo = evt.floorPosition;\n      owo2 = evt.value;\n      owo3 = note.time % 1e9 - evt.startTime;\n    }\n    note.floorPosition = owo + owo2 * owo3 / line.bpm * 1.875;\n    // if (j.type === 3) j.speed *= owo2;\n  }\n  for (const note of line.notesBelow) {\n    let owo = 0;\n    let owo2 = 0;\n    let owo3 = 0;\n    for (const evt of line.speedEvents) {\n      if (note.time % 1e9 > evt.endTime) continue;\n      if (note.time % 1e9 < evt.startTime) break;\n      owo = evt.floorPosition;\n      owo2 = evt.value;\n      owo3 = note.time % 1e9 - evt.startTime;\n    }\n    note.floorPosition = owo + owo2 * owo3 / line.bpm * 1.875;\n    // if (j.type === 3) j.speed *= owo2;\n  }\n}\nfunction updateDe(line) {\n  line.judgeLineDisappearEvents.sort((a, b) => a.startTime - b.startTime);\n  line.judgeLineMoveEvents.sort((a, b) => a.startTime - b.startTime);\n  line.judgeLineRotateEvents.sort((a, b) => a.startTime - b.startTime);\n  line.judgeLineDisappearEvents = arrangeLineEvent(line.judgeLineDisappearEvents);\n  line.judgeLineMoveEvents = arrangeLineEvent(line.judgeLineMoveEvents);\n  line.judgeLineRotateEvents = arrangeLineEvent(line.judgeLineRotateEvents);\n}\n/** @type {Map<AudioBuffer|null,boolean>|null} */\nlet kfcFkXqsVw50 = null;\nhook.before.set('kfcFkXqsVw50', () => {\n  if (!(kfcFkXqsVw50 instanceof Map)) return;\n  const /** @type {AudioBuffer|null} */ bgm = hook.bgms.get(hook.selectbgm.value).audio;\n  if (bgm != null) for (let i = 0; i < bgm.numberOfChannels; i++) bgm.getChannelData(i).reverse();\n  kfcFkXqsVw50.set(bgm, hook.awawa = !kfcFkXqsVw50.get(bgm));\n  hook.modify = hook.awawa ? a => reverse(a, hook.app.duration) : a => a;\n});\n/**\n * @param {import('@/utils/Chart').Chart} chart json\n * @param {number} duration time/s\n */\nexport function reverse(chart, duration) {\n  const chartNew = chart.duplicate();\n  chartNew.offset = -chartNew.offset;\n  for (const line of chartNew.judgeLineList) {\n    const tb = duration * line.bpm / 1.875;\n    for (const evt of line.speedEvents) reverseSpeedEvent(evt, tb);\n    for (const note of line.notesAbove) reverseNote(note, tb);\n    for (const note of line.notesBelow) reverseNote(note, tb);\n    updateSefp(line);\n    line.judgeLineDisappearEvents = arrangeLineEvent(line.judgeLineDisappearEvents);\n    line.judgeLineMoveEvents = arrangeLineEvent(line.judgeLineMoveEvents);\n    line.judgeLineRotateEvents = arrangeLineEvent(line.judgeLineRotateEvents);\n    for (const evt of line.judgeLineDisappearEvents) reverseLineEvent(evt, tb);\n    for (const evt of line.judgeLineMoveEvents) reverseLineEvent(evt, tb);\n    for (const evt of line.judgeLineRotateEvents) reverseLineEvent(evt, tb);\n    updateDe(line);\n  }\n  return chartNew.duplicate(); // 规范判定线事件\n}\n/**\n * @param {HTMLElement} elem\n * @param {()=>any} activeFn\n * @param {()=>any} doneFn\n */\nfunction longPress(elem, activeFn, doneFn, failFn) {\n  let timer = null;\n  elem.addEventListener('mousedown', awaIn);\n  elem.addEventListener('mouseup', awaOut);\n  elem.addEventListener('mouseleave', awaOut);\n  elem.addEventListener('touchstart', awaIn, { passive: true });\n  elem.addEventListener('touchend', awaOut);\n  elem.addEventListener('touchcancel', awaOut);\n  function awaIn() {\n    timer = requestAnimationFrame(awaIn);\n    if (activeFn()) {\n      cancelAnimationFrame(timer);\n      doneFn();\n      elem.removeEventListener('mousedown', awaIn);\n      elem.removeEventListener('mouseup', awaOut);\n      elem.removeEventListener('mouseleave', awaOut);\n      elem.removeEventListener('touchstart', awaIn);\n      elem.removeEventListener('touchend', awaOut);\n      elem.removeEventListener('touchcancel', awaOut);\n    }\n  }\n  function awaOut() {\n    cancelAnimationFrame(timer);\n    failFn();\n  }\n}\n(function() {\n  const tt = document.querySelector('.title');\n  if (!(tt instanceof HTMLElement)) return;\n  let pressTime = NaN;\n  const revolveWorld = () => {\n    if (isNaN(pressTime)) pressTime = performance.now();\n    tt.style.cssText += `;filter:hue-rotate(${(performance.now() - pressTime) / 4}deg)`;\n    if (performance.now() - pressTime > 3473 && Math.random() * 401 < 1) return 1;\n    return 0;\n  };\n  longPress(tt, revolveWorld, () => {\n    hook.fireModal('<p>Tip</p>', '<p>Reverse Mode is on...</p>');\n    kfcFkXqsVw50 = new Map();\n    setInterval(revolveWorld, 20);\n  }, () => {\n    tt.style.cssText += ';filter:hue-rotate(0deg);';\n    pressTime = NaN;\n  });\n}());\n"],"names":["arrangeLineEvent","events","oldEvents","JSON","parse","stringify","newEvents","startTime","endTime","start","end","start2","end2","push","length","i2","i1","newEvents2","shift","d1","d2","reverseLineEvent","evt","tb","reverseNote","note","time","type","speed","holdTime","reverseSpeedEvent","updateSefp","line","y","speedEvents","sort","a","b","floorPosition","value","bpm","notesAbove","owo","owo2","owo3","notesBelow","updateDe","judgeLineDisappearEvents","judgeLineMoveEvents","judgeLineRotateEvents","kfcFkXqsVw50","reverse","chart","duration","chartNew","duplicate","offset","judgeLineList","hook","before","set","Map","bgm","bgms","get","selectbgm","audio","i","numberOfChannels","getChannelData","awawa","modify","app","tt","document","querySelector","HTMLElement","pressTime","NaN","revolveWorld","o","isNaN","performance","now","style","cssText","Math","random","elem","activeFn","doneFn","failFn","timer","awaIn","requestAnimationFrame","cancelAnimationFrame","removeEventListener","awaOut","addEventListener","passive","longPress","fireModal","setInterval"],"mappings":"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"}